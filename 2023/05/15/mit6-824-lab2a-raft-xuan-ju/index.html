<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MIT6.824-Lab2A:Raft选举, 青雪">
    <meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MIT6.824-Lab2A:Raft选举 | 青雪</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.1"><link rel="alternate" href="/atom.xml" title="青雪" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<!-- 样式一（鼠标点击更换样式） -->
<script src="https://g.joyinshare.com/hc/ribbon.min.js" type="text/javascript"></script>
<!-- 样式二（飘动的彩带） -->
<script src="https://g.joyinshare.com/hc/piao.js" type="text/javascript"></script>
<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">青雪</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">青雪</div>
        <div class="logo-desc">
            
            本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MIT6.824-Lab2A:Raft选举</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MIT6-824/">
                                <span class="chip bg-color">MIT6.824</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" class="post-category">
                                分布式
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-05-15
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-05-15
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.1k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="实验概述"><a href="#实验概述" class="headerlink" title="实验概述"></a>实验概述</h2><p>在 MIT 6.824分布式系统课程中，第二个实验是实现分布式共识算法 Raft。这个实验分成了 A/B/C 三个部分，这篇将主要围绕 Part 2A 部分的实验，实现 Raft 中的Leader选举和心跳检测。</p>
<p>参考资料：</p>
<p><a href="https://link.zhihu.com/?target=http://thesecretlivesofdata.com/raft/">可视化raft</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md#52-%E9%A2%86%E5%AF%BC%E4%BA%BA%E9%80%89%E4%B8%BE">raft论文</a> 的section5</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/248686289">MIT 6.824 Lab2实验指导</a></p>
<p><a target="_blank" rel="noopener" href="https://gukaifeng.cn/posts/mit6.824-students-guide-to-raft-fan-yi/">MIT6.824 Students’ Guide to Raft</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/510801912">Raft Locking Advice</a></p>
<h2 id="实验思路"><a href="#实验思路" class="headerlink" title="实验思路"></a>实验思路</h2><p>在 Raft 的论文中，Figure 2 很好的描述了整个 Raft 算法的细节。</p>
<p><img src="http://blog-liuzhangjie.oss-cn-chengdu.aliyuncs.com/img/2023/20230515113004.png" alt="图 2：一个关于 Raft 一致性算法的浓缩总结（不包括成员变换和日志压缩）。"></p>
<p><img src="http://blog-liuzhangjie.oss-cn-chengdu.aliyuncs.com/img/2023/20230515170354.png" alt="中文版">  </p>
<p>而这张图则很好的展示了服务器节点状态转换的逻辑关系</p>
<p><img src="http://blog-liuzhangjie.oss-cn-chengdu.aliyuncs.com/img/2023/20230515124511.png" alt="服务器状态"> </p>
<p>这两张图，我认为非常重要，可以帮助我们理清思路。</p>
<p>接下来我们先梳理一下 Leader Election 的大致流程。</p>
<p>首先，一个 server 会有三种状态：Follower、Candidate 和 Leader。最开始的时候，所有的 server 的状态都为 Follower。对于每个 server，会初始化一个随机的选举超时时间（election timeout)，那么当一个 server 在这段时间里面没有收到来自 Candidate 或 Leader 的消息时，便将自己转变为 Candidate 并开始新一时期（Term）选举。Candidate 通过向其它 server 索取选票（Vote），得到半数以上便转变为 Leader。之后便定时向其它服务器发送心跳包（Heartbeat）来防止新的选举。</p>
<p>在以上流程中，我们需要注意一条重要的服务器规则：</p>
<blockquote>
<p>如果接收到的 RPC 请求或响应中，任期号<code>T &gt; currentTerm</code>，则令 <code>currentTerm = T</code>，并切换为跟随者状态（5.1 节）</p>
</blockquote>
<p>这条规则可以，结束选举流程，将服务器节点的状态从Leader和Candidate倒退到Follower。</p>
<p>代码主要思路</p>
<ul>
<li><p>所有状态都通过 <code>Raft</code> 结构体管理</p>
</li>
<li><p><code>Make()</code> 函数初始化所有状态变量，并通过 Goroutine 启动 <code>ticker()</code>，监测选举超时和心跳超时</p>
<ul>
<li>选举超时，重置选举超时时间<code>resetElectionTimer()</code>，服务器成为候选人<code>becomeCandidate()</code>，开始选举 <code>startElection()</code></li>
<li>心跳超时，重置心跳超时时间<code>resetHeartbeatTimer()</code>，服务器广播心跳<code>broadcastHeartbeat()</code></li>
</ul>
</li>
<li><p>在 <code>startElection()</code> 中，向其它服务器发送 RequestVote RPC ，统计得票数</p>
<ul>
<li><p>如果得票超过半数，则成为领导者<code>becomeLeader()</code>，并开始广播心跳<code>broadcastHeartbeat()</code></p>
</li>
<li><p>如果未得票超过半数，则当前 Term 不会有 Leader，于是选举超时被触发，开始新的选举</p>
</li>
</ul>
</li>
<li><p>心跳即空的 AppendEntries PRC</p>
</li>
<li><p>服务器节点收到有效RPC（args.term &gt;= currentTerm）时，重置自己的选举定时器</p>
</li>
</ul>
<h3 id="数据定义"><a href="#数据定义" class="headerlink" title="数据定义"></a>数据定义</h3><p>首先是各种结构体的定义，lab2A中所需要的数据类型基本上在论文中图2中给出了</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 定义Raft节点结构体</span>
type Raft struct <span class="token punctuation">{</span>
    mu        sync<span class="token punctuation">.</span>Mutex          <span class="token comment" spellcheck="true">// Lock to protect shared access to this peer's state</span>
    peers     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd <span class="token comment" spellcheck="true">// RPC end points of all peers</span>
    persister <span class="token operator">*</span>Persister          <span class="token comment" spellcheck="true">// Object to hold this peer's persisted state</span>
    me        <span class="token keyword">int</span>                 <span class="token comment" spellcheck="true">// this peer's index into peers[]</span>
    dead      int32               <span class="token comment" spellcheck="true">// set by Kill()</span>

    <span class="token comment" spellcheck="true">// state a Raft server must maintain.</span>
    CurrentTerm    <span class="token keyword">int</span>         <span class="token comment" spellcheck="true">// 服务器的任期号（初始化为 0，持续递增）</span>
    VotedFor       <span class="token keyword">int</span>         <span class="token comment" spellcheck="true">// 当前投票的候选人的 Id</span>
    Log            <span class="token punctuation">[</span><span class="token punctuation">]</span>LogEntry  <span class="token comment" spellcheck="true">// 日志条目集；每一个条目包含一个用户状态机执行的指令，和收到时的任期号</span>
    State          State       <span class="token comment" spellcheck="true">// 节点状态</span>
    ElectionTimer  <span class="token operator">*</span>time<span class="token punctuation">.</span>Timer <span class="token comment" spellcheck="true">// 选举定时器</span>
    HeartbeatTimer <span class="token operator">*</span>time<span class="token punctuation">.</span>Timer <span class="token comment" spellcheck="true">// 心跳定时器</span>
    VoteCount      <span class="token keyword">int</span>         <span class="token comment" spellcheck="true">// 获得的选票数</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 节点状态</span>
type State <span class="token keyword">int</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
    Follower  State <span class="token operator">=</span> iota <span class="token comment" spellcheck="true">// 跟随者</span>
    Candidate              <span class="token comment" spellcheck="true">// 候选人</span>
    Leader                 <span class="token comment" spellcheck="true">// 领导者</span>
<span class="token punctuation">)</span>
    
<span class="token comment" spellcheck="true">//    日志条目</span>
type LogEntry struct <span class="token punctuation">{</span>
    Term    <span class="token keyword">int</span>         <span class="token comment" spellcheck="true">// 领导者收到此条目时的任期号</span>
    Command <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 状态机执行的命令</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// RequestVote RPC 相关的定义</span>
type RequestVoteArgs struct <span class="token punctuation">{</span>
    Term         <span class="token keyword">int</span> <span class="token comment" spellcheck="true">//候选人的任期号</span>
    CandidateId  <span class="token keyword">int</span> <span class="token comment" spellcheck="true">//请求选票的候选人的 ID</span>
<span class="token punctuation">}</span>

type RequestVoteReply struct <span class="token punctuation">{</span>
    Term        <span class="token keyword">int</span>  <span class="token comment" spellcheck="true">//当前任期号，以便于候选人去更新自己的任期号</span>
    VoteGranted bool <span class="token comment" spellcheck="true">//候选人赢得了此张选票时为真</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//    AppendEntries RPC 相关的定义</span>
type AppendEntriesArgs struct <span class="token punctuation">{</span>
    Term         <span class="token keyword">int</span>        <span class="token comment" spellcheck="true">//领导者的任期号</span>
    LeaderId     <span class="token keyword">int</span>        <span class="token comment" spellcheck="true">//领导者的 Id，以便于跟随者重定向请求</span>
    Entries      <span class="token punctuation">[</span><span class="token punctuation">]</span>LogEntry <span class="token comment" spellcheck="true">//存储的日志条目（表示心跳时为空）</span>
    LeaderCommit <span class="token keyword">int</span>        <span class="token comment" spellcheck="true">//领导者已经提交的日志的索引值(commitIndex)</span>
<span class="token punctuation">}</span>

type AppendEntriesReply struct <span class="token punctuation">{</span>
    Term    <span class="token keyword">int</span>  <span class="token comment" spellcheck="true">//当前任期号，用于领导者去更新自己</span>
    Success bool <span class="token comment" spellcheck="true">//跟随者包含了匹配上 prevLogIndex 和 prevLogTerm 的日志时为真</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="超时检测"><a href="#超时检测" class="headerlink" title="超时检测"></a>超时检测</h3><p>关于超时检测，实验给出的建议是</p>
<blockquote>
<p>您将需要定期执行某些操作，或在一段时间后做些什么。最简单的方法是新起一个协程，在协程的循环中调用<a href="https://link.zhihu.com/?target=https://golang.org/pkg/time/%23Sleep">time.Sleep()</a>。不要使用<code>time.Timer</code>或<code>time.Ticker</code>，这两个并不好用，容易出错</p>
</blockquote>
<p>但我始终认为使用<code>loop+sleep</code> 来周期性检测超时，并不是十分优雅，所以还是实验性的使用<code>time.Timer</code>来进行周期性检测，至少在lab2A中没有出现问题。</p>
<p><code>time.Timer</code>是一个定时器， 我们可以在raft节点中设置两个定时器<code>ElectionTimer</code>和<code>HeartbeatTimer</code></p>
<p><code>make()</code>会新起一个协程执行<code>ticker()</code>，ticker 协程会定期收到两个 timer 的到期事件</p>
<ol>
<li>election timeout 后，Follower和Canadidate需要开始新一轮选举。</li>
<li>heartbeats timeout 后，Leader 需要向其他服务器发送 heartbeat 消息（使用 AppendEntries RPC）</li>
</ol>
<pre class=" language-java"><code class="language-java"><span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">ticker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">for</span> rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Your code here (2A)</span>
        <span class="token comment" spellcheck="true">// Check if a leader election should be started.</span>
        select <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;</span><span class="token operator">-</span>rf<span class="token punctuation">.</span>ElectionTimer<span class="token punctuation">.</span>C<span class="token operator">:</span>
            <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">==</span> Leader <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            rf<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            rf<span class="token punctuation">.</span><span class="token function">becomeCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            rf<span class="token punctuation">.</span><span class="token function">startElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">case</span> <span class="token operator">&lt;</span><span class="token operator">-</span>rf<span class="token punctuation">.</span>HeartbeatTimer<span class="token punctuation">.</span>C<span class="token operator">:</span>
            <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">==</span> Leader <span class="token punctuation">{</span>
                rf<span class="token punctuation">.</span><span class="token function">resetHeartbeatTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                rf<span class="token punctuation">.</span><span class="token function">broadcastHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 重置选举计时器</span>
<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rf<span class="token punctuation">.</span>ElectionTimer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    rf<span class="token punctuation">.</span>ElectionTimer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token function">randomElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 随机选举超时时间,选举超时应该在 300 到 450 毫秒范围内</span>
func <span class="token function">randomElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Duration <span class="token punctuation">{</span>
    <span class="token keyword">return</span> time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">150</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 重置心跳计时器</span>
<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">resetHeartbeatTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rf<span class="token punctuation">.</span>HeartbeatTimer<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    rf<span class="token punctuation">.</span>HeartbeatTimer<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token function">fixedHeartbeatTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 固定心跳超时时间</span>
func <span class="token function">fixedHeartbeatTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Duration <span class="token punctuation">{</span>
    <span class="token keyword">return</span> time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="领导人选举"><a href="#领导人选举" class="headerlink" title="领导人选举"></a>领导人选举</h3><p>首先是 <code>RequestVote RPC handler</code>的实现，完全按照图2</p>
<pre class=" language-java"><code class="language-java"><span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">RequestVote</span><span class="token punctuation">(</span>args <span class="token operator">*</span>RequestVoteArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>RequestVoteReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    defer rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//如果term &lt; currentTerm或已经投票返回 false</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">||</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>Term <span class="token operator">==</span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span>VotedFor <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span>VotedFor <span class="token operator">!=</span> args<span class="token punctuation">.</span>CandidateId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>CurrentTerm
        reply<span class="token punctuation">.</span>VoteGranted <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment" spellcheck="true">//如果term > currentTerm，切换为跟随者</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">></span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token punctuation">{</span>
        rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>Term
        rf<span class="token punctuation">.</span>VotedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        rf<span class="token punctuation">.</span>State <span class="token operator">=</span> Follower
    <span class="token punctuation">}</span>

    rf<span class="token punctuation">.</span>VotedFor <span class="token operator">=</span> args<span class="token punctuation">.</span>CandidateId
    rf<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>CurrentTerm
    reply<span class="token punctuation">.</span>VoteGranted <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendRequestVote</span><span class="token punctuation">(</span>server <span class="token keyword">int</span><span class="token punctuation">,</span> args <span class="token operator">*</span>RequestVoteArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>RequestVoteReply<span class="token punctuation">)</span> bool <span class="token punctuation">{</span>
    ok <span class="token operator">:</span><span class="token operator">=</span> rf<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"Raft.RequestVote"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ok
<span class="token punctuation">}</span>
</code></pre>
<p>然后是实现<code>startElection()</code> 函数用来并发发送 RequestVote RPC 请求，统计投票结果</p>
<ul>
<li>如果接收到大多数服务器的选票，那么就变成领导人</li>
<li>如果接收到来自新的领导人的附加日志（AppendEntries）RPC，则转变成跟随者</li>
<li>如果选举过程超时，则再次发起一轮选举（这部分在ticker中处理）</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">startElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">==</span> Candidate <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//选票数</span>
        rf<span class="token punctuation">.</span>VoteCount <span class="token operator">=</span> <span class="token number">1</span>

        <span class="token comment" spellcheck="true">//给所有其他节点发送投票请求</span>
        <span class="token keyword">for</span> peer <span class="token operator">:</span><span class="token operator">=</span> range rf<span class="token punctuation">.</span>peers <span class="token punctuation">{</span>
            <span class="token keyword">if</span> peer <span class="token operator">!=</span> rf<span class="token punctuation">.</span>me <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//异步调用自检</span>
                <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">!=</span> Candidate <span class="token punctuation">{</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
                go rf<span class="token punctuation">.</span><span class="token function">requestVote</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">requestVote</span><span class="token punctuation">(</span>peer <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">!=</span> Candidate <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    args <span class="token operator">:</span><span class="token operator">=</span> RequestVoteArgs<span class="token punctuation">{</span><span class="token punctuation">}</span>
    args<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>CurrentTerm
    args<span class="token punctuation">.</span>CandidateId <span class="token operator">=</span> rf<span class="token punctuation">.</span>me

    reply <span class="token operator">:</span><span class="token operator">=</span> RequestVoteReply<span class="token punctuation">{</span><span class="token punctuation">}</span>

    ok <span class="token operator">:</span><span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">sendRequestVote</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//rpc阻塞调用自检</span>
    <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">!=</span> Candidate <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
        rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        defer rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> reply<span class="token punctuation">.</span>VoteGranted <span class="token punctuation">{</span>
            rf<span class="token punctuation">.</span>VoteCount<span class="token operator">++</span>
            <span class="token comment" spellcheck="true">//如果获得了大多数的选票，就成为领导人</span>
            <span class="token keyword">if</span> rf<span class="token punctuation">.</span>VoteCount <span class="token operator">></span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">{</span>
                rf<span class="token punctuation">.</span><span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                rf<span class="token punctuation">.</span><span class="token function">resetHeartbeatTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                rf<span class="token punctuation">.</span><span class="token function">broadcastHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> reply<span class="token punctuation">.</span>Term <span class="token operator">></span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token punctuation">{</span>
            rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Term
            rf<span class="token punctuation">.</span>State <span class="token operator">=</span> Follower
            rf<span class="token punctuation">.</span>VotedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            rf<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="心跳检测"><a href="#心跳检测" class="headerlink" title="心跳检测"></a>心跳检测</h3><p>首先是RPC handle的实现，同样是完全按照图2</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// AppendEntries RPC handler.</span>
<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">AppendEntries</span><span class="token punctuation">(</span>args <span class="token operator">*</span>AppendEntriesArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>AppendEntriesReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    defer rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//如果term &lt; currentTerm, 返回 false</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token punctuation">{</span>
        reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>CurrentTerm
        reply<span class="token punctuation">.</span>Success <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//如果 RPC 请求或响应包含的任期号 T > currentTerm，切换状态为跟随者</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">></span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token punctuation">{</span>
        rf<span class="token punctuation">.</span>State <span class="token operator">=</span> Follower
        rf<span class="token punctuation">.</span>VotedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>Term
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//重置超时时间</span>
    rf<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>CurrentTerm
    reply<span class="token punctuation">.</span>Success <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>



<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendAppendEntries</span><span class="token punctuation">(</span>server <span class="token keyword">int</span><span class="token punctuation">,</span> args <span class="token operator">*</span>AppendEntriesArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>AppendEntriesReply<span class="token punctuation">)</span> bool <span class="token punctuation">{</span>
    ok <span class="token operator">:</span><span class="token operator">=</span> rf<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">"Raft.AppendEntries"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ok
<span class="token punctuation">}</span>
</code></pre>
<p>然后是实现<code>broadcastHeartbeat() </code> 函数用来并发发送 AppendEntries RPC 请求，</p>
<pre class=" language-java"><code class="language-java"><span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">broadcastHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> peer <span class="token operator">:</span><span class="token operator">=</span> range rf<span class="token punctuation">.</span>peers <span class="token punctuation">{</span>
        <span class="token keyword">if</span> peer <span class="token operator">!=</span> rf<span class="token punctuation">.</span>me <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//异步调用自检</span>
            <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">!=</span> Leader <span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            go rf<span class="token punctuation">.</span><span class="token function">sendHeartbeat</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token function">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendHeartbeat</span><span class="token punctuation">(</span>peer <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> rf<span class="token punctuation">.</span>State <span class="token operator">!=</span> Leader <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    args <span class="token operator">:</span><span class="token operator">=</span> AppendEntriesArgs<span class="token punctuation">{</span><span class="token punctuation">}</span>
    args<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>CurrentTerm
    args<span class="token punctuation">.</span>LeaderId <span class="token operator">=</span> rf<span class="token punctuation">.</span>me

    reply <span class="token operator">:</span><span class="token operator">=</span> AppendEntriesReply<span class="token punctuation">{</span><span class="token punctuation">}</span>

    rf<span class="token punctuation">.</span><span class="token function">sendAppendEntries</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>args<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span>

    rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    defer rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//rpc阻塞调用自检</span>
    <span class="token keyword">if</span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">!=</span> args<span class="token punctuation">.</span>Term <span class="token operator">||</span> rf<span class="token punctuation">.</span>State <span class="token operator">!=</span> Leader <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//处理返回体，如果对方的任期号比自己大，就转换为跟随者</span>
    <span class="token keyword">if</span> reply<span class="token punctuation">.</span>Term <span class="token operator">></span> rf<span class="token punctuation">.</span>CurrentTerm <span class="token punctuation">{</span>
        rf<span class="token punctuation">.</span>CurrentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Term
        rf<span class="token punctuation">.</span>State <span class="token operator">=</span> Follower
        rf<span class="token punctuation">.</span>VotedFor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
        rf<span class="token punctuation">.</span><span class="token function">resetElectionTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="经验教训"><a href="#经验教训" class="headerlink" title="经验教训"></a>经验教训</h2><h3 id="重置选举计时器"><a href="#重置选举计时器" class="headerlink" title="重置选举计时器"></a>重置选举计时器</h3><p>在我的代码中，以及<a href="https://link.zhihu.com/?target=http://thesecretlivesofdata.com/raft/">可视化raft</a>的逻辑都是收到 <code>AppendEntries</code> 或 <code>RequestVote</code> RPC 时，都会会重置对等点的选举计时器</p>
<p>但<a target="_blank" rel="noopener" href="https://gukaifeng.cn/posts/mit6.824-students-guide-to-raft-fan-yi/">MIT6.824 Students’ Guide to Raft </a>对此有不同的看法，大家可以参考参考</p>
<blockquote>
<p>例如，当您收到 <code>AppendEntries</code> 或 <code>RequestVote</code> RPC 时，您可能会合理地重置对等点的选举计时器，因为两者都表明其他对等点要么认为它是领导者，要么正试图成为领导者。直观地说，这意味着我们不应该干涉。但是，如果您仔细阅读图 2，它会说：</p>
<p>If election timeout elapses without receiving <code>AppendEntries</code> RPC <strong><code>from current leader</code></strong> or <strong><code>granting</code></strong> vote to candidate: convert to candidate.</p>
<p>如果选举超时过去了，没有从当前领导者那里收到 <code>AppendEntries RPC</code>，也没有给候选人投票：转换为候选人。</p>
<p>事实证明，这种区别很重要，因为在某些情况下，前一种实现可能会导致活跃度显着降低。</p>
</blockquote>
<h3 id="加锁"><a href="#加锁" class="headerlink" title="加锁"></a>加锁</h3><p>课程给出了关于加锁的建议，可以仔细阅读</p>
<p><a href="https://link.zhihu.com/?target=https://pdos.csail.mit.edu/6.824/labs/raft-locking.txt">Raft Locking Advice</a> </p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/510801912">Raft Locking Advice中文翻译</a></p>
<p>但作者自己都说这些建议很难讲清楚，实际写代码时也很难应用。作者提出了更有实操性的做法。</p>
<blockquote>
<p>One approach is to start with code that has no locks, and think carefully about where one needs to add locks to attain correctness. This approach can be difficult since it requires reasoning about the correctness of concurrent code.<br>A more pragmatic approach starts with the observation that if there were no concurrency (no simultaneously executing goroutines), you would not need locks at all. But you have concurrency forced on you when the RPC system creates goroutines to execute RPC handlers, and because you need to send RPCs in separate goroutines to avoid waiting. You can effectively eliminate this concurrency by identifying all places where goroutines start (RPC handlers, background goroutines you create in Make(), &amp;c), acquiring the lock at the very start of each goroutine, and only releasing the lock when that goroutine has completely finished and returns.</p>
</blockquote>
<p>总的来说就是写代码的时候先不考虑concurrency，没有concurrency当然不需要考虑锁，当你需要加concurrency的时候，你再加锁。</p>
<p><code>go test -race</code>可以发现很多需要加锁的地方</p>
<h3 id="注意更新term"><a href="#注意更新term" class="headerlink" title="注意更新term"></a>注意更新term</h3><p>任何时候，任何server发现自己的term落后，都要更新term。</p>
<ul>
<li>Leader向follower发送append entries时，自己的term小于follower的term</li>
<li>Follower收到leader发送的append entries时，自己的term小于leader的term</li>
<li>Candidate向其他server发送request vote时，自己的term小于其他server的term</li>
<li>Server收到Candidate发送的request vote时，自己的term小于Candidate的term</li>
</ul>
<h3 id="尽可能打印信息"><a href="#尽可能打印信息" class="headerlink" title="尽可能打印信息"></a>尽可能打印信息</h3><p>调试代码的一个好方法，就是在 Peer 发送或收到消息时打印自己的状态，并在测试时运行<code>go test -run 2A &gt; out</code>，将日志收集到文件中。然后，通过研究 <code>out</code> 文件，可以确定实现中不正确的地方。您可能会喜欢用<code>util. go</code>中的<code>Dprintf</code>函数来调试，其可以在不同情况下打开和关闭日志。</p>
<h2 id="调试测试"><a href="#调试测试" class="headerlink" title="调试测试"></a>调试测试</h2><p>和2A有关的3个测试，满足要求的难度从小到大。以下是它们做的事情。</p>
<p><code>TestInitialElection</code>测试启动后Raft集群是否能够选出一个leader，并检查在网络稳定的情况，也就是不应该发生心跳信号等待超时的情况下，是否能保持原来的leader和term状态不变。</p>
<p><code>TestReElection</code>测试在上一个测试的基础上，检查发生leader离线情况的行为。先等待集群产生一个leader，然后让这个<code>leader</code>离线，检查集群能否再产生一个leader。若能，令原来的leader上线，检查leader不应该发生变化，因为后来的leader的term大于原来的leader。如果满足要求，令一个leader和一个follower离线，检查此时集群不应该再产生新leader，因为超过半数的服务器离线了。</p>
<p><code>TestManyElections</code>测试是上一个测试的现实版本。每次随机令2个服务器离线，检查集群状态是否符合要求。如此重复10次。为了确保测试的准确性，可以把这个重复次数改成1000,只需要改变量iters就可以。</p>
<p>可以点进<code>config.go</code>里面多看看这些测试是怎么实现的，这里就不展开了。</p>
<p>测试 Part 2A：</p>
<p><img src="http://blog-liuzhangjie.oss-cn-chengdu.aliyuncs.com/img/2023/20230515111857.png" alt="lab2A实验结果"> </p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">liuzhangjie</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://liuzhangjie1713.github.io/2023/05/15/mit6-824-lab2a-raft-xuan-ju/">https://liuzhangjie1713.github.io/2023/05/15/mit6-824-lab2a-raft-xuan-ju/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">liuzhangjie</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MIT6-824/">
                                    <span class="chip bg-color">MIT6.824</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    
        <div class="card" data-aos="fade-up">
    <div id="utteranc-container" class="card-content">
        <script src="https://utteranc.es/client.js"
        repo="liuzhangjie1713/blog-comment"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
        </script>
    </div>
</div>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/06/05/xie-shi-fu-zhi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="写时复制">
                        
                        <span class="card-title">写时复制</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            写入时复制（英语：Copy-on-write，简称COW）是一种计算机程式设计领域的优化策略。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-06-05
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            liuzhangjie
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MIT6-824/">
                        <span class="chip bg-color">MIT6.824</span>
                    </a>
                    
                    <a href="/tags/Linux/">
                        <span class="chip bg-color">Linux</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/03/17/jvm/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="JVM">
                        
                        <span class="card-title">JVM</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            JVM学习笔记
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-03-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 青雪<br />'
            + '文章作者: liuzhangjie<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020-2023</span>
            
            <span id="year">2020</span>
            <a href="/about" target="_blank">liuzhangjie</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/liuzhangjie1713" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1977216208@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1977216208" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1977216208" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
